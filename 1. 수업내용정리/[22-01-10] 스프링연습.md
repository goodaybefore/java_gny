게시판까지 구현하기

### 1. spring legacy project 생성 및 서버로 테스트하기

### 2. 인코딩 설정하기

### 3. 패키지명 변경

- 패키지명 수정
- servlet-context.xml에서 base-package명 수정

### 4. 타일즈 적용 및 테스트 하기

- 블로그 참고 : stajun.tistory.com

search.maven.org => sonatype

스프링 프레임워크 의존성 추가를 더 알고싶다

여기에 내가 원하는 의존성을 검색해보면 (ex.spring-webmvc)

항목(groupId, artifactid)들의 최신버전과 버전변 종류를 알 수 있다.(버전을 선택해서 숫자 수정을 해주면됨)

클릭하면 apache maven, gradle 등을 선택할 수 있음.(우리는 apache maven을 선택)



### 5. 각종 패키지 생성

- service
- dao
- vo
- 





### 6. DB연동

- 블로그 참고



### 7. DB연동 테스트

- MemberService 인터페이스

- MemberServiceImp 클래스

- MemberDAO 인터페이스

- MemberMapper.xml에 샘플코드 추가

  - src/main/resources폴더에 mappers폴더 생성
  - MemberMapper.xml파일 생성 후 샘플코드 추가
  - namespace부분을 현재 프로젝트에 알맞게 수정
  - mapper 태그안에 예제코드를 삭제

- MemberVO클래스 생성

  - 테이블 속성과 멤버변수 이름이 같게 생성
  - getter/setter생성과 toString을 오버라이딩함

- 컨트롤러에 멤버변수로MemberService 추가

  - Autowirde이용

  서버를 재가동하여 에러가 안나는지 테스트

- 컨트롤러에 샘플코드 추가 및 테스트

- 컨트롤러/서비스/다오/매퍼에 샘플코드 추가 및 테스트

  - DB에 샘플 데이터를 추가

  - 컨트롤러 샘플 코드

    - ```java
      @RequestMapping(value = "/", method = RequestMethod.GET)
      public ModelAndView openTilesView(ModelAndView mv) throws Exception {
      	mv.setViewName("/main/home");
      	System.out.println("DB test");
      	//연동 확인 후 지울 코드
          //qwe는 샘플 데이터에 있는 회원 아이디
      	MemberVO user = memberService.testSQL("qwe");
      	System.out.println(user);
      	return mv;
      }
      ```

  - Service 샘플 코드

    - ```java
      MemberVO testSQL(String string);
      ```

  - ServiceImp 샘플코드

    - ```java
      @Override
      public MemberVO testSQL(String id) {
      	return memberDao.testSQL(id);
      }
      ```

    - 

  - DAO 샘플코드

    - ```java
      MemberVO testSQL(@Param("id")String id);
      ```

  - Mapper 샘플코드

### 8. 회원가입 기능 구현(비밀번호 암호화 적용)

- github.com/st8324/Docs 참고

- hearder.jsp에 회원가입 링크 추가

- 컨트롤러에 회원가입 화면을 보여주는 메소드를 추가

  - /signup에 GET방식

- 회원가입 화면 파일을 생성. member폴더에 signup.jsp 생성

  - 회원가입 화면을 구성

- 컨트롤러에 회원가입을 처리하는 메소드를 추가

  - /signup에 POST방식
  - 회원가입이 정상적으로 진행되면 메인페이지(/)로 이동시킴
  - 회원가입이 비정상적으 진행될 시 회원가입 페이지(/signup)으로 이동시킴

- 화면에서 전달한 회원정보를 컨트롤러에 받은 후 확인

  - 매개변수를 추가(MemberVO user)

  - 생일과 관련된 에러가 발생할 수 있음

    - 원인 : 화면에서는 yyyy-mm-dd로 된 문자열을 전송하는데, 생일이 Date클래스로 지정되어 있으면 자동형변환이 안됨

    - 해결방안 : setMe_brith(string)로 setter를 수정하여 문자열로 된 날짜를 Date로 변환하는 코드를 작성해야함

      ```java
      public void setMe_birth(String me_birth){
          SimpleDateFormat format;
          try{
              format = new SimpleDateFormat("yyyy-MM-dd");
              this.me_birth = format.parse(me_birth);
          }catch(ParseException e){
              e.printStackTrace();
          }
      }
      ```

      

  - 화면에 input/textarea/select태그 등의 name을 MemberVO의 매개변수와 일치하게 설정

- 컨트롤러에서 회원정보를 서비스에게 주면서 회원가입진행하라고 시킴

  - 이 때 서비는 회원가입이 성공했는지 실패했는지 컨트롤러에게 알려줌(리턴타입 : trun, false)

- Service에 회원가입 메소드 추가

  - 컨트롤러에서 에러나는 부분 마우스 hover

- ServiceImp에 회원가입 메소드 추가

  - 마우스 hover

- ServiceImp에서 회원가입 기능 구현

  - 비밀번호 암호화 진행
  - DAO에게 회원가입 정보를 전달한 후 가입 진행을 시킴

- DAO에 회원가입 메소드 추가

  - ServiceImp에서 에러나는 부분 hover
  - @Param("변수명")을 매개변수 앞에 추가

- Mapper에 쿼리문 구현

  - DAO에 추가한 메소드명을 id에 입력
  - 쿼리문 구현

### 8-1 비밀번호 암호화

- http://github.com/st8324/Docs 참고



### 9. 로그인 기능 구현(Interceptor를 이용한 로그인 유지 적용)

- 로그인 유지 문서 참고 링크 : http://github.com/st8324/Docs
- header.jsp에 링크 추가
- 컨트롤러에서 메소드 추가 및 코드 구현
- 로그인 화면 구성
  - form 태그 이용
  - name 설정 : VO의 변수 이름과 같아야함
- 로그인 시도시 Controller에서 회원 정보가 잘 오는지 확인
- Service와 ServiceImp에 코드를 구현
  - 비밀번호 암호화를 이용하여 비밀번호를 확인
  - DAO에 메소드 추가
  - Mapper에 쿼리문 추가
    - resultType설정시 오타 주의
  - 문서 참고하여 로그인 유지 기능
    - http://github.com/st8324/Docs
  - 로그인시 로그아웃메뉴 보이기
  - 로그아웃시 로그인메뉴 보이기



### 10. 로그아웃

- 로그아웃 링크 추가
- 컨트롤러에 로그아웃 코드 구현

### 11.인터셉터를 이용해서 회원만 게시글 등록/수정/삭제가 되도록 처리

- 참고문서 링크

- 다음 URL에 대하여 회워만 접근하도록 인터셉터를 생성후 처리(MemberInterceptor)

  - /board/register
  - /board/modify
  - /board/detail

- 다음 URL에 대해 비로그인 회원만 접근하도록 인터셉터를 생성후 처리(GuestInterceptor)

  - /login
  - /signup

- GuestInterceptor

  ```java
  @Override
  	public boolean preHandle(HttpServletRequest request, 
  			HttpServletResponse response, 
  			Object handler)
  			throws Exception {
  		//request안에 세션이 있는데 그 안에 유저정보가 있는지 없는지 가죠오는 코드 
  		HttpSession session = request.getSession();
  		Object user = session.getAttribute("user");
  		//유저정보가 있으면 넘어올 수 없도록 막아줌
  		if(user != null) {
  			response.sendRedirect(request.getContextPath()+"/");
  		}
  		return true;
  	}
  ```



### 12. 인터셉터를 이용하여 비회원만 로그인/회원가입이 되도록 처리

- 참고문서 github.com/st8324 
- 다음 url 에 대해 로그인하지 않은 비회원만 접근하도록 인터셉터를 생성후 처리(GuestInterceptor)
- /login
- /signup

### 13. 게시글 리스트 확인 구현

- URL: /board/list

- 게시글 링크 등록

- 보드 컨트롤러, 버드 서비스, 보드 서비스임플, 보드다오, 보드매퍼, 보드VO추가

  - Controller 클래스 생성 후 @Controller 추가
  - Service는 인터페이스로
  - ServiceImp은 클래스로, @Service 추가
  - DAO는 인터페이스로
  - Mapper는 xml로 생성 후 namespace를 DAO의 경로로 설정
  - ---여기까지가 생성 ----
  - ----여기서부터는 연결
  - Autowired를 이용하여 멤버변수 설정
    - 컨트롤러에 멤버변수로 서비스를 설정
    - 서비스임플에 멤버변수로 다오를 설정

- 컨트롤러에서 게시글 리스트를 확인하는 메소드 등록 및 구현

  ```java
  @Controller
  @RequestMapping(value="/board")
  //컨트롤러 바로밑에 저거 추가하면 밑에 RequestMapping에서 value=에 /board를 추가할 필요가없어짐!
  ```

  

- Service와 ServiceImp에 게시글 가져오는 메소드 등록 및 구현

- DAO와 Mapper에 게시글 가져오는 메소드 등록및 쿼리문 작성

- 확인

### 14. 게시글 상세 확인

- /board/detail
- 게시글 리스트에서 게시글 제목 링크를 수정
- 컨트롤러에서 해당 메소드 처리하는 코드 등록 및 구현
- Service/ServiceImp에서 메소드 등록 및 구현
- 다오/매퍼에서 메소드 등록 및 구현
- 게시글 상세화면 구현



### 15. 게시글 등록

- board/register
- 게시글 리스트에서 게시글 등록 버튼 추가
  - 등록 버튼을 클릭하면 /borad/register로 이동
- 게시글 등록 화면 구현(Controller - get)
  - 컨트롤러에 해당 URL을 담당하는 메소드 등록 및 코드 구현
  - 기본 등록화면 jsp 생성
  - 게시글 등록 화면 구현
    - form태그 이용
      - method = post
- 게시글 등록 기능 구현(Controller - post)
- 테스트시 로그인을 꼭 해야 테스트 가능
  - Controller에 게시글 등록하는 메소드 등록 및 코드 구현
    - 게시글 등록 후 완료되면 /board/list로 이동하도록 처리
    - 화면에서 입력한 게시글이 오는지 확인
    - 로그인한 사용자 정보를 확인
    - Service에게 일을 시킴
  - Service/ServiceImp에 메소드 등록 및 구현
    - 게시글 제목이 존재하는지 확인
  - DAO/Mapper에 메소드 등록 및 쿼리문 구현
    - INSERT문 이용
- 게시글 등록 화면 jsp



### 16. 게시글 수정

- /board/modify
- 게시글 상세에서 게시글 수정 버튼을 추가
  - 작성자와 로그인한 user가 같은 경우에만 보이도록 작성
- 게시글 수정 화면(get)
  - Controller에 method등록 및 코드 구현
  - 게시글 수정 화면 jsp 생성
  - Controller에서 수정할 게시글의 번호를 확인
  - Controller에서 회원 정보 확인
  - Service에게 게시글 가져오라고 시킴
  - 게시글의 작성자와 회원 아이디가 일치하면 수정화면으로 이동
  - 일치하지 않으면 게시글 상세로 이동
  - 가져온 게시글 정보를 게시글 수정 화면에 출력
- 게시글 수정 기능(post)
  - Controller에서 method 등록 및 코드구현
    - 수정을 다 하면 게시글 상세로 이동
    - 수정된 게시글 정보 확인
    - 로그인한 회원 정보 확인
    - 서비스에게 수정하라고 시킴
  - Service/ServiceImp에 method 등록 및 구현
    - 접속한 회원이 작성자인지 확인하고, 일치하면 게시글 수정
  - DAO/Mapper에게 method 등록 및 쿼리 구현
    - 수정된 게시글 정보를 DB에 업데이트

### 17. 게시글 삭제

- /board/delete
- 게시글 상세에서 삭제버튼을 추가
  - 작성자만 보이도록 작업
  - 버튼을 클릭하면 삭제 링크로 이동하도록 작업
  - 수정 버튼 참고
- Controller에서 메소등록 및 코드 구현
  - get방식으로 구현
  - 삭제를 다 하면 /board/list로 이동시킴
  - 삭제할 게시글 번호를 확인
  - 로그인한 회원을 확인
  - Service에게 삭제하라고 시킴
    - 필요한 매개변수 설정을 잘 해야함
- Service/ServiceImp에 메소드 등록 및 구현
  - 유효한 번호인지 확인
    - 유효하지 않으면 삭제 종료
  - 번호와 일치하는 게시글 가져오기
  - 게시글이 없으면 삭제 종료
  - 게시글이 있으면 게시글 작성자와 로그인한 회원 아이디가 같은지 확인
    - 같으면 게시글 삭제
    - DAO에게 bd_del = 'Y'로 수정하라고 시킴
  - DAO/Mapper에 메소드 등록 및 쿼리 구현
    - DAO에 메소드 등록 후 @Param
    - update 쿼리문 작성



### 18. 첨부파일 추가

- 기존 게시글에 첨부파일을 등록하는 기능을 추가

  - 업로드를 위한 의존성 추가

    - ```xml
      <dependency>
          <groupId>commons-fileupload</groupId>
          <artifactId>commons-fileupload</artifactId>
          <version>1.3.2</version>
      </dependency>
      ```

  - servlet-context.xml에 업로드 크기 추가

    - ```xml
      <!-- servlet-context.xml -->
      <beans:bean id="multipartResolver" class="org.springframework.web.multipart.commons.CommonsMultipartResolver">
          <!-- 업로드 최대 크기 10Mb -->
          <beans:property name="maxUploadSize" value="10485760"></beans:property>
      </beans:bean>
      ```

  - 패키지 생성 및 UploadFileUtils 클래스 추가

    -  기본패키지명.utils 패키지 생성

1. 게시글 등록할 때 첨부파일 기능 추가

   - register.jsp에 form태그 속성으로 enctype을 추가하고, 값을 설정

     - ```html
       <form method="post" enctype="multipart/form-data">
           <!-- 화면 구현부분 생략 -->
       </form>
       ```

     - enctype을 설정하지 않으면, 서버로 전송할 때 실제 파일을 전송하는게 아니라 파일 이름만 전송하게됨.

   - register.jsp에 첨부파일을 선택할 수 있도록 input태그 추가

     - `<input type="file" name="xxx">`

     - ```html
       <div class="form-group">
           <label>첨부파일</label>
           <input type="file" class="form-control" name="files"/>
           <input type="file" class="form-control" name="files"/>
           <input type="file" class="form-control" name="files"/>
       </div>
       ```

   - Controller에서 첨부파일을 받을 수 있도록 매개변수를 추가

     - POST에 추가

     - ```java
       //매개변수 명은 register.jsp에 있는 name과 일치해야함
       List<MultipartFile> files
       ```

   - Controller에서 Service에게 시킨 게시글 등록기능에첨부파일 추가

   - Service에서 게시글 등록 메소드를 수정하고, 첨부파일을 매개변수로 추가

   - ServiceImp에 첨부파일을 매개변수로 추가

   - 게시글을 등록하고나서, 등록된 게시글의 게시글 번호를 가져오도록 xml수정

     - BoardMapper.xml의 insertBoard에 다음을 추가

       - ```java
         <insert id="insertBoard"
         		useGeneratedKeys="true"
         		keyProperty="board.bd_num"
         		parameterType="kr.green.green.vo.BoardVO">
         ```

       - keyProperty

         - board : DAO에서 정한 이름. DAO에서 @Param("xxx")이 부분에서 xxx에 해당
         - bd_num : VO의 기본키 이름

   - ServiceImp에 첨부파일 등록 기능

     - 첨부파일이 있으면 반복문을 이용하여 서버에 업로드하고, DAO에게 첨부파일을 등록하도록 시킴

     - ServiceImp에 첨부파일 경로를 멤버변수로 추가

       - 실제 폴더 경로

     - FileVO 생성

       - 테이블 속성 이름과 VO멤버변수 이름을 일치시켜야함.

       - 파일명, 경로파일명, 게시글번호를 이용한 생성자 추가

       - 기본생성자 추가 (@NoArgsConstructor) : Args = arguments = 매개변수의 약자

       - ```java
         //파일명, 경로파일명, 게시글번호를 이용한 생성자
         //generate using fields
         public FileVO(String fi_ori_name, String fi_name, int fi_bd_num) {
         	this.fi_ori_name = fi_ori_name;
         	this.fi_name = fi_name;
         	this.fi_bd_num = fi_bd_num;
         }
         ```

   - DAO에 메소드 추가 및 Mapper에 쿼리문 추가

     - Mapper에 insert문
     - DAO에 @Param 추가

2. 게시글 확인할 때 첨부파일 목록을 확인하고 클릭시 다운로드하는 기능 추가

3. 게시글 수정할 때 첨부파일 수정기능을 추가

4. 게시글 삭제할 때 첨부파일 삭제 기능 추가

5. 



### DB연동시 에러가 발생하는 경우

1. 에러 내용에 다음이 들어간 경우

   ```java
   Error creating bean with name 'homeController' : Unsatisfied dependency expressed through field 'memberService';
   ```

   - 경우1 : MembserServiceImp에 @Service를 빼먹은 경우
   - 경우2 : servlet-context.xml에 base-package를 잘못 설정한경우

   

2. 에러내용에 다음이 들어갈 경우

   ```java
   Error creating bean with name 'memberServiceImp' : Unsatisfied dependency expressed through field 'memberDao'
   ```

   - 경우1 : root-context.xml에 mybatis-spring:scan base-package를 잘못 설정한 경우
   - 경우2 : memberDAO를 interface가 아닌 class로 만든 경우

   

3. 에러 내용에 다음이 들어간 경우

   ```java
   Invalid bound statement (not found) : kr.green.green.dao.MemberDAO.test
   ```

   - 경우1 : MemberMapper.xml에 namespace에 오타가 있는 경우
   - 경우2 : MemberMapper.xml의 id에 오타가 있는 경우

   

4. 에러 내용에 다음이 들어간 경우

   ```java
   Could not resolve type alias 'kr.green.green.vo.MemberVO2'. Cause: java.lang.ClassNotFoundException: Cannot find class: kr.green.green.vo.MemverVO2
   ```

   - 경우 : MemberMapper.xml에 resultType에 오타가 있는 경우

   

5. xml파일과 관련된 에러 발생 후 올바르게 수정했는데도 계속 에러가 발생하는 경우

   - 원인 : 수정 내용이 제대로 반영되지 않아서
   - 해결방안 : 프로젝트 선택 후 Alt+F5 눌러서 적용시키기

   

6. 에러 내용에 다음이 들어간 경우

   ```java
   Could not resolver resource location pattern [classpath:mappers/**/Mapper.xml]:
   class path resource [mappers/] cannot be resolved to URL it does not exist
   ```

   - 경우 : mappers 폴더 위치가 src/main/resources가 아니거나 폴더 이름에 오타가 있는 경우

   

7. 404 에러 중 콘솔창에 다음 경고가 뜨는 경우

   ```java
   WRAN : org.springframework.web.servlet.PageNotFound - no mapping for GET/green/login
   ```

   - 경우1 : 컨트롤러에 URL을 담당하는 메소드를 만들지 않은 경우
   - 경우2 : 새 컨트롤러에 메소드를 제대로 만들었지만 컨트롤러 위에 @Controller를 빼먹은 경우

   

8.  405에러 중 콘솔창에 다음 경고가 뜨는 경우

   ```java
   Request method 'POST' not supported
   ```

   - 경우 : 컨트롤러의 URL중 POST를 담당하는 메소드를 만들지 않은 경우







## My Error Note

1. SQL ERROR

   ```java
   SQLIntegrityConstraintViolationException: Cannot add or update a child row: a foreign key constraint fails (`community`.`board`, CONSTRAINT `FK_board_TO_board_1` FOREIGN KEY (`bd_ori_num`) REFERENCES `board` (`bd_num`));
   
   Cannot add or update a child row: a foreign key constraint fails (`community`.`board`, CONSTRAINT `FK_board_TO_board_1` FOREIGN KEY (`bd_ori_num`) REFERENCES `board` (`bd_num`));
   
   nested exception is java.sql.SQLIntegrityConstraintViolationException: Cannot add or update a child row: a foreign key constraint fails (`community`.`board`, CONSTRAINT `FK_board_TO_board_1` FOREIGN KEY (`bd_ori_num`) REFERENCES `board` (`bd_num`));
   ```

   - 